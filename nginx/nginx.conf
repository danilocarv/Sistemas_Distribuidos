# Bloco 'events' é obrigatório, fica aqui fora.
events {}

# Bloco 'http' começa aqui
http {

    # --- CORREÇÃO: O 'map' VAI AQUI ---
    # (Dentro do 'http', mas antes do 'server')
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 80;

        # Rota padrão para o frontend React
        location / {
            # Assumindo que seu frontend expõe a porta 80
            proxy_pass http://frontend; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Rota para o serviço de LISTAS
        # (Mantendo sua regra de rewrite)
        location /api/lists/ {
            rewrite ^/api/lists/(.*)$ /listas/$1 break;
            proxy_pass http://listas-service:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Rota para o serviço de ITENS
        # (Mantendo sua regra de rewrite)
        location /api/items/ {
            rewrite ^/api/items/(.*)$ /items/$1 break;
            proxy_pass http://itens-service:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Rota para a conexão WebSocket (Socket.IO)
        location /socket.io/ {
            proxy_pass http://itens-service:3002;
            proxy_http_version 1.1;

            # Agora isso vai funcionar
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400s; 
            proxy_send_timeout 86400s;
        }
    }
}